<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Detalle de Película</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bitcount+Grid+Single:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body class="d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="../index.html">CinePlus</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="../index.html">Inicio</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="renta.html">Renta</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="contacto.html">Contacto</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-5" id="detalle-pelicula">
      <div class="text-center mb-4">
        <h2 id="titulo" class="mb-3"></h2>

        <!-- Alerta dinamica (JS) -->
        <div id="alerta-estado" class="alert alert-info" role="alert">
          ¡Disfruta del tráiler oficial y conoce más sobre esta película!
        </div>

        <!-- Trailer embebido -->
        <div class="ratio ratio-16x9 mb-4">
          <iframe
            id="trailer"
            src=""
            allowfullscreen
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          >
          </iframe>
        </div>
      </div>

      <!-- Tarjeta con sinopsis e imagen -->
      <div class="card mb-4">
        <div class="row g-0">
          <div class="col-md-4">
            <img
              id="poster"
              src=""
              class="img-fluid rounded-start"
              alt="Póster de la película"
              loading="lazy"
              onerror="this.onerror=null;this.src='../img/placeholder.jpg';"
            />
          </div>
          <div class="col-md-8">
            <div class="card-body">
              <h5 class="card-title">Sinopsis</h5>
              <p id="sinopsis" class="card-text"></p>

              <!-- Badges de generos -->
              <div id="generos" class="d-flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Seccion de Resenias -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">Reseñas</h5>
            <div id="reseñas-resumen" class="text-muted small"></div>
          </div>
          <ul id="reseñas-lista" class="list-group list-group-flush"></ul>
        </div>
      </div>

      <div class="text-center">
        <a href="../index.html" class="btn btn-secondary">Volver al inicio</a>
      </div>
    </div>

    <footer class="site-footer text-center py-3 mt-auto">
      <small>&copy; 2025 CinePlus. Todos los derechos reservados.</small>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
      $(function () {
        const ESTRENO_DIAS_VIGENCIA = 7; // días con precio de estreno
        const currency = new Intl.NumberFormat("es-EC", {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 2,
        });

        // Helpers de fecha (interpretar ISO)
        function parseLocalDate(iso) {
          return new Date(iso + "T00:00:00");
        }
        function diffDays(from, to) {
          const MS = 24 * 60 * 60 * 1000;
          const a = new Date(
            from.getFullYear(),
            from.getMonth(),
            from.getDate()
          );
          const b = new Date(to.getFullYear(), to.getMonth(), to.getDate());
          return Math.round((b - a) / MS);
        }

        function calcularPrecioYEstado(peli) {
          const hoy = new Date();
          const estreno = parseLocalDate(peli.estreno);
          const dias = diffDays(estreno, hoy);

          const precioEstreno = Number(peli?.precios?.estreno ?? NaN);
          const precioNormal = Number(peli?.precios?.normal ?? NaN);
          const fmt = (n) => (Number.isFinite(n) ? currency.format(n) : "—");

          if (dias < 0) {
            return {
              clase: "alert-warning",
              titulo: "Próximamente",
              detalle: `Estrena el ${estreno.toLocaleDateString("es-EC")}`,
              precioActual: fmt(precioEstreno),
            };
          } else if (dias < ESTRENO_DIAS_VIGENCIA) {
            return {
              clase: "alert-danger",
              titulo: "Estreno",
              detalle: `Día ${dias + 1} de ${ESTRENO_DIAS_VIGENCIA}`,
              precioActual: fmt(precioEstreno),
            };
          } else {
            return {
              clase: "alert-success",
              titulo: "En cartelera",
              detalle: `Desde ${estreno.toLocaleDateString("es-EC")}`,
              precioActual: fmt(precioNormal),
            };
          }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");

        $.ajax({
          url: "../data/peliculas.json",
          method: "GET",
          dataType: "json",
          success: function (peliculas) {
            const peli = Array.isArray(peliculas)
              ? peliculas.find((p) => String(p.id) === String(id))
              : null;

            if (peli) {
              // Titulo
              $("#titulo").text(peli.titulo);

              // Poster
              $("#poster")
                .attr("src", "../img/" + peli.imagen)
                .attr("alt", "Póster de " + peli.titulo);

              // Sinopsis
              $("#sinopsis").text(peli.sinopsis);

              // Trailer
              $("#trailer")
                .attr("src", peli.trailer)
                .attr("title", "Tráiler de " + peli.titulo);

              // Géneros (array --> badges)
              const generos = Array.isArray(peli.generos)
                ? peli.generos
                : peli.generos
                ? [peli.generos]
                : [];
              const badges = generos
                .map((g) => `<span class="badge bg-secondary">${g}</span>`)
                .join("");
              $("#generos").html(badges);

              // Alert dinamica: estado y precio actual
              const estado = calcularPrecioYEstado(peli);
              $("#alerta-estado")
                .removeClass(
                  "alert-info alert-warning alert-danger alert-success"
                )
                .addClass(estado.clase).html(`
                  <div><strong>${estado.titulo}</strong> • Precio actual: <strong>${estado.precioActual}</strong></div>
                  <div class="small text-body-secondary">${estado.detalle}</div>
                `);

              cargarResenas(peli.id); //llamos para cargar las resenias
            } else {
              mostrarError();
            }
          },
          error: function () {
            mostrarError();
          },
        });

        function mostrarError() {
          $("#detalle-pelicula").html(`
            <div class="alert alert-danger text-center" role="alert">
              No se pudo cargar la información de la película.
            </div>
            <div class="text-center">
              <a href="../index.html" class="btn btn-secondary mt-3">Volver al inicio</a>
            </div>
          `);
        }
      });

      // --- Funciones para las resenias ---
      function renderStars(n) {
        const val = Math.max(0, Math.min(5, Math.round(Number(n) || 0)));
        const llenas = "★".repeat(val);
        const vacias = "☆".repeat(5 - val);
        return `<span class="text-warning" aria-label="${val} de 5">${llenas}</span><span class="text-muted">${vacias}</span>`;
      }

      function cargarResenas(peliculaId) {
        const url = "../data/resenas.json";
        $("#reseñas-lista").html(`
    <li class="list-group-item text-center">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <span class="ms-2">Cargando reseñas…</span>
    </li>
  `);

        $.getJSON(url)
          .done(function (data) {
            const reseñas = (Array.isArray(data) ? data : []).filter(
              (r) => String(r.peliculaId) === String(peliculaId)
            );
            if (reseñas.length === 0) {
              $("#reseñas-lista").html(
                `<li class="list-group-item text-center text-muted">Aún no hay reseñas.</li>`
              );
              $("#reseñas-resumen").text("");
              return;
            }

            const promedio =
              reseñas.reduce(
                (acc, r) => acc + (Number(r.calificacion) || 0),
                0
              ) / reseñas.length;
            const promedioTxt = promedio.toFixed(1);

            $("#reseñas-resumen").html(`
        <span class="me-2">${renderStars(promedio)}</span>
        <span>${promedioTxt}/5 · ${reseñas.length} reseña(s)</span>
      `);

            const items = reseñas
              .map(
                (r) => `
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">${r.usuario}</div>
              <div class="small text-muted">${new Date(
                r.fecha + "T00:00:00"
              ).toLocaleDateString("es-EC")}</div>
            </div>
            <div>${renderStars(r.calificacion)}</div>
          </div>
          <p class="mb-0 mt-2">${r.comentario}</p>
        </li>
      `
              )
              .join("");

            $("#reseñas-lista").html(items);
          })
          .fail(function () {
            $("#reseñas-lista").html(
              `<li class="list-group-item text-center text-danger">No se pudieron cargar las reseñas.</li>`
            );
            $("#reseñas-resumen").text("");
          });
      }
    </script>
  </body>
</html>
